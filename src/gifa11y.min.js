/*
 * Gifa11y
 * @author: Adam Chaboryk
 * @version: 1.0.7
 * @license: MIT
 */
class Gifa11y{"use strict";constructor(options){let defaultConfig;options={...{buttonBackground:"indigo",buttonBackgroundHover:"rebeccapurple",buttonIconColor:"white",buttonFocusColor:"#00e7ffad",buttonIconSize:"1.5rem",buttonIconFontSize:"1rem",buttonPlayIconID:"",buttonPauseIconID:"",buttonPlayIconHTML:"",buttonPauseIconHTML:"",container:"body",exclusions:"",gifa11yOff:"",inheritClasses:!0,initiallyPaused:!1,langPause:"Pause animation:",langPlay:"Play animation:",langPauseAllButton:"Pause all animations",langPlayAllButton:"Play all animations",langMissingAlt:"Missing image description.",langAltWarning:"&#9888; Error! Please add alternative text to GIF.",missingAltWarning:!0},...options};let $gifs=[];this.initialize=()=>{this.exclusions();const gifa11yOff=document.querySelectorAll(options.gifa11yOff);0===gifa11yOff.length&&(this.generateCSS(),document.addEventListener("DOMContentLoaded",e=>{this.findGifs(),this.generateStill(),this.prepareButtons(),this.toggleEverything()},!1))},this.exclusions=()=>{const separator=", ";if(options.gifa11yOff.length>0){let offSelectors=options.gifa11yOff.split(",");options.gifa11yOff=".gifa11y-off, "+offSelectors.join()}else options.gifa11yOff=".gifa11y-off";if(options.exclusions.length>0){let containerSelectors=options.exclusions.split(",");for(let i=0;i<containerSelectors.length;i++)containerSelectors[i]=containerSelectors[i]+" *, "+containerSelectors[i];options.exclusions=".gifa11y-ignore, "+containerSelectors.join()}else options.exclusions=".gifa11y-ignore"},this.findGifs=()=>{const maincontainer=document.querySelector(options.container),allGifs=maincontainer?Array.from(maincontainer.querySelectorAll('img[src$=".gif"]:not([src*="gifa11y-ignore"])')):[],excludeGifs=maincontainer?Array.from(maincontainer.querySelectorAll(options.exclusions)):[],filteredGifs=allGifs.filter($el=>!excludeGifs.includes($el));filteredGifs.forEach(($gif,index)=>{$gifs[index]=$gif})},this.generateStill=()=>{function waitForImage($el){let ext;if(ext=$el.src.split("."),ext=ext[ext.length-1].toLowerCase(),ext=ext.substring(0,4),"gif"===ext){const canvas=document.createElement("canvas");let borderLeft,borderRight,totalBorderWidth=parseFloat(getComputedStyle($el,null).getPropertyValue("border-left-width"))+parseFloat(getComputedStyle($el,null).getPropertyValue("border-right-width")),gifWidth=$el.getAttribute("width");null!==gifWidth?(canvas.width=gifWidth,canvas.setAttribute("style","width:"+gifWidth+"px !important;")):0==$el.clientWidth?canvas.width=$el.naturalWidth+.5+totalBorderWidth:canvas.width=$el.clientWidth+.5+totalBorderWidth;const newHeight=$el.naturalHeight/$el.naturalWidth*canvas.width;if(canvas.height=newHeight+.5,canvas.setAttribute("role","img"),!0===options.inheritClasses){let cssClasses=$el.getAttribute("class");null==cssClasses&&(cssClasses=""),canvas.setAttribute("class","gifa11y-canvas "+cssClasses)}else canvas.setAttribute("class","gifa11y-canvas");let alt=$el.getAttribute("alt");null!=alt&&""!=alt&&" "!=alt||(alt=options.langMissingAlt),canvas.setAttribute("aria-label",alt);const filename=$el.src,mediaQuery=window.matchMedia("(prefers-reduced-motion: reduce)");!mediaQuery||mediaQuery.matches||$el.classList.contains("gifa11y-paused")||filename.indexOf("gifa11y-paused")>-1||!0===options.initiallyPaused?($el.style.display="none",$el.setAttribute("data-gifa11y-state","paused")):(canvas.style.display="none",$el.setAttribute("data-gifa11y-state","playing"));const canvasContext=canvas.getContext("2d");canvasContext.drawImage($el,0,0,canvas.width,canvas.height),$el.after(canvas)}}$gifs.forEach($el=>{$el.complete?waitForImage($el):$el.addEventListener("load",()=>{waitForImage($el)})})},this.prepareButtons=()=>{function waitForImage($el){const mediaQuery=window.matchMedia("(prefers-reduced-motion: reduce)"),findCanvas=$el.nextElementSibling;let initialState,currentState,pauseDisplay,playDisplay,filename=$el.src;!mediaQuery||mediaQuery.matches||$el.classList.contains("gifa11y-paused")||filename.indexOf("gifa11y-paused")>-1||!0===options.initiallyPaused?(initialState=options.langPlay,playDisplay="block",pauseDisplay="none",currentState="paused"):(initialState=options.langPause,playDisplay="none",pauseDisplay="block",currentState="playing");let alt=$el.getAttribute("alt");if((null==alt||""==alt||" "==alt)&&(alt=options.langMissingAlt,!0===options.missingAltWarning)){const warning=document.createElement("span");warning.classList.add("gifa11y-warning"),warning.innerHTML=`${options.langAltWarning}`,findCanvas.after(warning)}const pauseButton=document.createElement("button"),defaultPlayIcon='<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg>',defaultPauseIcon='<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/></svg>';pauseButton.classList.add("gifa11y-btn"),pauseButton.setAttribute("aria-label",initialState+" "+alt),pauseButton.setAttribute("data-gifa11y-state",currentState),pauseButton.setAttribute("data-gifa11y-alt",alt),pauseButton.innerHTML=`<div class="gifa11y-pause-icon" aria-hidden="true" style="display: ${pauseDisplay}"></div><div class="gifa11y-play-icon" aria-hidden="true" style="display: ${playDisplay}"></div>`;const pauseIcon=pauseButton.querySelector(".gifa11y-pause-icon"),playIcon=pauseButton.querySelector(".gifa11y-play-icon");if(options.buttonPauseIconID.length>1){const customPauseIcon=document.getElementById(options.buttonPauseIconID).innerHTML;pauseIcon.innerHTML=customPauseIcon}else options.buttonPauseIconHTML.length>1?pauseIcon.innerHTML=options.buttonPauseIconHTML:pauseIcon.innerHTML=defaultPauseIcon;if(options.buttonPlayIconID.length>1){const customPlayIcon=document.getElementById(options.buttonPlayIconID).innerHTML;playIcon.innerHTML=customPlayIcon}else options.buttonPlayIconHTML.length>1?playIcon.innerHTML=options.buttonPlayIconHTML:playIcon.innerHTML=defaultPlayIcon;$el.closest("a[href]")?$el.closest("a[href]").insertAdjacentElement("beforebegin",pauseButton):$el.insertAdjacentElement("beforebegin",pauseButton),pauseButton.addEventListener("click",e=>{pauseButton.setAttribute("data-gifa11y-state","paused"===pauseButton.getAttribute("data-gifa11y-state")?"playing":"paused");const play=pauseButton.querySelector(".gifa11y-play-icon"),pause=pauseButton.querySelector(".gifa11y-pause-icon");"paused"===pauseButton.getAttribute("data-gifa11y-state")?($el.style.display="none",findCanvas.style.display="block",play.style.display="block",pause.style.display="none",pauseButton.setAttribute("aria-label",options.langPlay+" "+alt)):($el.style.display="block",findCanvas.style.display="none",play.style.display="none",pause.style.display="block",pauseButton.setAttribute("aria-label",options.langPause+" "+alt)),e.preventDefault()},!1)}$gifs.forEach($el=>{$el.complete?waitForImage($el):$el.addEventListener("load",()=>{waitForImage($el)})})},this.toggleEverything=()=>{const everythingBtn=document.getElementById("gifa11y-all"),mediaQuery=window.matchMedia("(prefers-reduced-motion: reduce)"),html=document.querySelector("html");function toggleAll(){everythingBtn.addEventListener("click",()=>{const html=document.querySelector("html");html.setAttribute("data-gifa11y-all","paused"===html.getAttribute("data-gifa11y-all")?"playing":"paused");const pageState=html.getAttribute("data-gifa11y-all"),allCanvas=document.querySelectorAll("canvas.gifa11y-canvas"),allBtns=document.querySelectorAll("button.gifa11y-btn");let playDisplay,pauseDisplay,currentState,ariaLabel;"paused"===pageState?(playDisplay="block",pauseDisplay="none",currentState="paused",ariaLabel=options.langPlay,everythingBtn.innerText=options.langPlayAllButton):(playDisplay="none",pauseDisplay="block",currentState="playing",ariaLabel=options.langPause,everythingBtn.innerText=options.langPauseAllButton),$gifs.forEach($el=>{$el.style.display=pauseDisplay}),allCanvas.forEach($el=>{$el.style.display=playDisplay}),allBtns.forEach($el=>{let alt=$el.getAttribute("data-gifa11y-alt"),play=$el.querySelector(".gifa11y-play-icon"),pause=$el.querySelector(".gifa11y-pause-icon");play.style.display=playDisplay,pause.style.display=pauseDisplay,$el.setAttribute("data-gifa11y-state",currentState),$el.setAttribute("aria-label",ariaLabel+" "+alt)})})}null!==everythingBtn&&(!mediaQuery||mediaQuery.matches||!0===options.initiallyPaused?(html.setAttribute("data-gifa11y-all","paused"),everythingBtn.innerText=options.langPlayAllButton):(html.setAttribute("data-gifa11y-all","playing"),everythingBtn.innerText=options.langPauseAllButton),everythingBtn.setAttribute("disabled",!0),Promise.all(Array.from($gifs).filter($el=>!$el.complete).map($el=>new Promise(resolve=>{$el.onload=$el.onerror=resolve}))).then(()=>{toggleAll(),everythingBtn.removeAttribute("disabled")}))},this.generateCSS=()=>{const stylesheet=document.createElement("style");stylesheet.innerHTML=`\n\t\t\t\tbutton.gifa11y-btn,\n\t\t\t\tspan.gifa11y-warning {\n\t\t\t\t\tall: unset;\n\t\t\t\t\tbox-sizing: border-box !important;\n\t\t\t\t}\n\t\t\t\tbutton.gifa11y-btn {\n\t\t\t\t\tbackground: ${options.buttonBackground} !important;\n\t\t\t\t\tcolor: ${options.buttonIconColor} !important;\n\t\t\t\t\tborder-radius: 50% !important;\n\t\t\t\t\tbox-shadow: 0 0 16px 0 #0000004f !important;\n\t\t\t\t\tborder: 2px solid white !important;\n\t\t\t\t\tcursor: pointer !important;\n\t\t\t\t\tdisplay: block !important;\n\t\t\t\t\tline-height: normal !important;\n\t\t\t\t\tmin-height: 36px !important;\n\t\t\t\t\tmin-width: 36px !important;\n\t\t\t\t\ttext-align: center !important;\n\t\t\t\t\tmargin: 12px !important;\n\t\t\t\t\tpadding: 4px !important;\n\t\t\t\t\tposition: absolute !important;\n\t\t\t\t\ttransition: all .2s ease-in-out !important;\n\t\t\t\t\tz-index: 500 !important;\n\t\t\t\t}\n\t\t\t\tbutton.gifa11y-btn:hover, button.gifa11y-btn:focus {\n\t\t\t\t\tbackground: ${options.buttonBackgroundHover} !important;\n\t\t\t\t}\n\t\t\t\tbutton.gifa11y-btn:focus {\n\t\t\t\t\tbox-shadow: 0 0 0 5px ${options.buttonFocusColor} !important;\n\t\t\t\t\toutline: 3px solid transparent;\n\t\t\t\t}\n\t\t\t\tdiv.gifa11y-play-icon i,\n\t\t\t\tdiv.gifa11y-pause-icon > i {\n\t\t\t\t\tfont-size: ${options.buttonIconFontSize} !important;\n\t\t\t\t\tpadding: 4px !important;\n\t\t\t\t\tvertical-align: middle !important;\n\t\t\t\t\tmin-width: calc(${options.buttonIconFontSize} * 1.4) !important;\n    \t\t\tmin-height: calc(${options.buttonIconFontSize} * 1.4) !important;\n\t\t\t\t}\n\t\t\t\tdiv.gifa11y-pause-icon > svg,\n\t\t\t\tdiv.gifa11y-play-icon > svg {\n\t\t\t\t\tflex-shrink: 0 !important;\n\t\t\t\t\tposition: relative !important;\n\t\t\t\t\tvertical-align: middle !important;\n\t\t\t\t\theight: ${options.buttonIconSize} !important;\n\t\t\t\t\twidth: ${options.buttonIconSize} !important;\n\t\t\t\t\t-webkit-transform: translate(0px,0px) !important;\n\t\t\t\t}\n\t\t\t\tspan.gifa11y-warning {\n\t\t\t\t\tbackground: darkred !important;\n\t\t\t\t\tcolor: white !important;\n\t\t\t\t\tpadding: 5px !important;\n\t\t\t\t\tfont-size: 1.1rem !important;\n\t\t\t\t\tdisplay: block !important;\n\t\t\t\t\tfont-family: Arial !important;\n\t\t\t\t\tmax-width: 450px !important;\n\t\t\t\t}\n\t\t\t\t/* Increase target size of button. */\n\t\t\t\tbutton.gifa11y-btn:before {\n\t\t\t\t\tcontent: "" !important;\n\t\t\t\t\tinset: -8.5px !important;\n\t\t\t\t\tmin-height: 50px !important;\n\t\t\t\t\tmin-width: 50px !important;\n\t\t\t\t\tposition: absolute !important;\n\t\t\t\t}\n\t\t\t\tcanvas.gifa11y-canvas {\n\t\t\t\t\tobject-fit: contain !important;\n\t\t\t\t\tmax-width: 100%;\n\t\t\t\t}\n\t\t\t\t`,document.getElementsByTagName("head")[0].appendChild(stylesheet)},this.initialize()}}