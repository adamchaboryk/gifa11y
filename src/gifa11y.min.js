/*
 * Gifa11y
 * @author: Adam Chaboryk
 * @version: 0.1
 * @license: MIT
 */
class Gifa11y{"use strict";constructor(options){let defaultConfig;options={...{buttonBackground:"indigo",buttonBackgroundHover:"rebeccapurple",buttonIconColor:"white",buttonFocusColor:"#00e7ffad",container:"body",exclusions:"",gifa11yOff:"",inheritClasses:!0,initiallyPaused:!1,langPause:"Pause animation:",langPlay:"Play animation:",langPauseAllButton:"Pause all animations",langPlayAllButton:"Play all animations",langMissingAlt:"Missing image description.",langAltWarning:"&#9888; Error! Please add alternative text to GIF.",missingAltWarning:!0},...options};let $gifs=[];this.initialize=()=>{this.exclusions();const gifa11yOff=document.querySelectorAll(options.gifa11yOff);0===gifa11yOff.length&&(this.generateCSS(),document.addEventListener("DOMContentLoaded",e=>{this.findGifs(),this.generateStill(),this.prepareButtons(),this.toggleEverything()},!1))},this.exclusions=()=>{const separator=", ";if(options.gifa11yOff.length>0){let offSelectors=options.gifa11yOff.split(",");options.gifa11yOff=".gifa11y-off, "+offSelectors.join()}else options.gifa11yOff=".gifa11y-off";if(options.exclusions.length>0){let containerSelectors=options.exclusions.split(",");for(let i=0;i<containerSelectors.length;i++)containerSelectors[i]=containerSelectors[i]+" *, "+containerSelectors[i];options.exclusions=".gifa11y-ignore, "+containerSelectors.join()}else options.exclusions=".gifa11y-ignore"},this.findGifs=()=>{const maincontainer=document.querySelector(options.container),allGifs=Array.from(maincontainer.querySelectorAll('img[src$=".gif"]:not([src*="gifa11y-ignore"])')),excludeGifs=Array.from(maincontainer.querySelectorAll(options.exclusions)),filteredGifs=allGifs.filter($el=>!excludeGifs.includes($el));filteredGifs.forEach(($gif,index)=>{$gifs[index]=$gif})},this.generateStill=()=>{function waitForImage($el){let ext;if(ext=$el.src.split("."),ext=ext[ext.length-1].toLowerCase(),ext=ext.substring(0,3),"gif"===ext){const canvas=document.createElement("canvas");let borderLeft,borderRight,totalBorderWidth=parseFloat(getComputedStyle($el,null).getPropertyValue("border-left-width"))+parseFloat(getComputedStyle($el,null).getPropertyValue("border-right-width")),gifWidth=$el.getAttribute("width");if(null!==gifWidth?(canvas.width=gifWidth,canvas.setAttribute("style","width:"+gifWidth+"px !important;")):canvas.width=$el.clientWidth+.5+totalBorderWidth,canvas.height=$el.clientHeight+.5,canvas.setAttribute("role","img"),!0===options.inheritClasses){let cssClasses=$el.getAttribute("class");null==cssClasses&&(cssClasses=""),canvas.setAttribute("class","gifa11y-canvas "+cssClasses)}else canvas.setAttribute("class","gifa11y-canvas");let alt=$el.getAttribute("alt");null!=alt&&""!=alt&&" "!=alt||(alt=options.langMissingAlt),canvas.setAttribute("aria-label",alt);const filename=$el.src,mediaQuery=window.matchMedia("(prefers-reduced-motion: reduce)");!mediaQuery||mediaQuery.matches||$el.classList.contains("gifa11y-paused")||filename.indexOf("gifa11y-paused")>-1||!0===options.initiallyPaused?($el.style.display="none",$el.setAttribute("data-gifa11y-state","paused")):(canvas.style.display="none",$el.setAttribute("data-gifa11y-state","playing"));const canvasContext=canvas.getContext("2d");canvasContext.drawImage($el,0,0,canvas.width,canvas.height),$el.after(canvas)}}$gifs.forEach($el=>{$el.complete?waitForImage($el):$el.addEventListener("load",()=>{waitForImage($el)})})},this.prepareButtons=()=>{function waitForImage($el){const mediaQuery=window.matchMedia("(prefers-reduced-motion: reduce)"),findCanvas=$el.nextElementSibling;let initialState,currentState,pauseDisplay,playDisplay,filename=$el.src;!mediaQuery||mediaQuery.matches||$el.classList.contains("gifa11y-paused")||filename.indexOf("gifa11y-paused")>-1||!0===options.initiallyPaused?(initialState=options.langPlay,playDisplay="block",pauseDisplay="none",currentState="paused"):(initialState=options.langPause,playDisplay="none",pauseDisplay="block",currentState="playing");let alt=$el.getAttribute("alt");if((null==alt||""==alt||" "==alt)&&(alt=options.langMissingAlt,!0===options.missingAltWarning)){const warning=document.createElement("span");warning.classList.add("gifa11y-warning"),warning.innerHTML=`${options.langAltWarning}`,findCanvas.after(warning)}const svg=`\n\t\t\t\t<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">\n\t\t\t\t\t<path class="gifa11y-pause-icon" style="display: ${pauseDisplay}" d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/>\n\t\t\t\t\t<path class="gifa11y-play-icon" style="display: ${playDisplay}" d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>\n\t\t\t\t</svg>`,pauseButton=document.createElement("button");pauseButton.classList.add("gifa11y-btn"),pauseButton.setAttribute("aria-label",initialState+" "+alt),pauseButton.setAttribute("data-gifa11y-state",currentState),pauseButton.setAttribute("data-gifa11y-alt",alt),pauseButton.innerHTML=svg,$el.closest("a[href]")?$el.closest("a[href]").insertAdjacentElement("beforebegin",pauseButton):$el.insertAdjacentElement("beforebegin",pauseButton),pauseButton.addEventListener("click",e=>{pauseButton.setAttribute("data-gifa11y-state","paused"===pauseButton.getAttribute("data-gifa11y-state")?"playing":"paused");const play=pauseButton.querySelector(".gifa11y-play-icon"),pause=pauseButton.querySelector(".gifa11y-pause-icon");"paused"===pauseButton.getAttribute("data-gifa11y-state")?($el.style.display="none",findCanvas.style.display="block",play.style.display="block",pause.style.display="none",pauseButton.setAttribute("aria-label",options.langPlay+" "+alt)):($el.style.display="block",findCanvas.style.display="none",play.style.display="none",pause.style.display="block",pauseButton.setAttribute("aria-label",options.langPause+" "+alt)),e.preventDefault()},!1)}$gifs.forEach($el=>{$el.complete?waitForImage($el):$el.addEventListener("load",()=>{waitForImage($el)})})},this.toggleEverything=()=>{const everythingBtn=document.getElementById("gifa11y-all"),mediaQuery=window.matchMedia("(prefers-reduced-motion: reduce)"),html=document.querySelector("html");function toggleAll(){everythingBtn.addEventListener("click",()=>{const html=document.querySelector("html");html.setAttribute("data-gifa11y-all","paused"===html.getAttribute("data-gifa11y-all")?"playing":"paused");const pageState=html.getAttribute("data-gifa11y-all"),allCanvas=document.querySelectorAll("canvas.gifa11y-canvas"),allBtns=document.querySelectorAll("button.gifa11y-btn");let playDisplay,pauseDisplay,currentState,ariaLabel;"paused"===pageState?(playDisplay="block",pauseDisplay="none",currentState="paused",ariaLabel=options.langPlay,everythingBtn.innerText=options.langPlayAllButton):(playDisplay="none",pauseDisplay="block",currentState="playing",ariaLabel=options.langPause,everythingBtn.innerText=options.langPauseAllButton),$gifs.forEach($el=>{$el.style.display=pauseDisplay}),allCanvas.forEach($el=>{$el.style.display=playDisplay}),allBtns.forEach($el=>{let alt=$el.getAttribute("data-gifa11y-alt"),play=$el.querySelector("svg path.gifa11y-play-icon"),pause=$el.querySelector("svg path.gifa11y-pause-icon");play.style.display=playDisplay,pause.style.display=pauseDisplay,$el.setAttribute("data-gifa11y-state",currentState),$el.setAttribute("aria-label",ariaLabel+" "+alt)})})}null!==everythingBtn&&(!mediaQuery||mediaQuery.matches||!0===options.initiallyPaused?(html.setAttribute("data-gifa11y-all","paused"),everythingBtn.innerText=options.langPlayAllButton):(html.setAttribute("data-gifa11y-all","playing"),everythingBtn.innerText=options.langPauseAllButton),everythingBtn.setAttribute("disabled",!0),Promise.all(Array.from($gifs).filter($el=>!$el.complete).map($el=>new Promise(resolve=>{$el.onload=$el.onerror=resolve}))).then(()=>{toggleAll(),everythingBtn.removeAttribute("disabled")}))},this.generateCSS=()=>{const stylesheet=document.createElement("style");stylesheet.innerHTML=`button.gifa11y-btn, span.gifa11y-warning {all: unset;box-sizing: border-box !important;}button.gifa11y-btn {background: ${options.buttonBackground}!important;color: ${options.buttonIconColor}!important;border-radius: 50% !important;box-shadow: 0 0 16px 0 #0000004f !important;border: 2px solid white !important;cursor: pointer !important;display: block !important;float:right !important;font-size: 0 !important;height: 36px !important;width: 36px !important;line-height: normal !important;text-align: center !important;margin: 12px !important;min-width: 0 !important;padding: 0 !important;position: absolute !important;transition: all .2s ease-in-out !important;z-index: 500 !important;}button.gifa11y-btn:hover, button.gifa11y-btn:focus {background: ${options.buttonBackgroundHover}!important;}button.gifa11y-btn:focus {box-shadow: 0 0 0 5px ${options.buttonFocusColor}!important;outline: 3px solid transparent;}button.gifa11y-btn > svg {flex-shrink: 0 !important;position: relative !important;height: 24px !important;width: 24px !important;}span.gifa11y-warning {background: darkred !important;color: white !important;padding: 5px !important;font-size: 16px !important;display: block !important;font-family: Arial !important;max-width: 400px !important;}button.gifa11y-btn:before {content: "" !important;top: -8.5px !important;left: -8.5px !important;height: 50px !important;width: 50px !important;position: absolute !important;}canvas.gifa11y-canvas {object-fit: contain !important;}`,document.getElementsByTagName("head")[0].appendChild(stylesheet)},this.initialize()}};